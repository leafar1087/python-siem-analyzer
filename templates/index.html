{% extends "base.html" %}

{% block title %}Dashboard - SIEM{% endblock %}

{% block content %}

    <div class="dashboard-grid">

        <div id="stats-container">
            <h2>Estad√≠sticas Clave</h2>
            
            <div class="stats-content"> 
                <div class="chart-container">
                    <h3>Conteo por Nivel</h3>
                    <canvas id="chartNivel"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top IPs Activas</h3>
                    <canvas id="chartIPs"></canvas>
                </div>
            </div>
        </div>

        <div id="log-container">
            <h2>Logs en Vivo</h2>
            
            <table width="100%">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP de Origen</th>
                        <th>Severidad</th>
                        <th>Mensaje</th>
                        <th>Analizar</th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                    <tr><td colspan="4">Cargando datos desde la API...</td></tr>
                </tbody>
            </table>

            <div id="pagination-controls" style="margin-top: 15px; text-align: center;">
                <button id="btn-anterior" onclick="cambiarPagina('anterior')">&laquo; Anterior</button>
                <span id="page-info" style="margin: 0 15px;">P√°gina ? de ?</span>
                <button id="btn-siguiente" onclick="cambiarPagina('siguiente')">Siguiente &raquo;</button>
            </div>
        </div>

    </div>

    </div> <div id="ai-modal" class="modal-oculto">
        <div class="modal-contenido">
            <span class_ ="modal-cerrar" onclick="cerrarModal()">&times;</span>
            <h2>ü§ñ Asistente de An√°lisis de IA</h2>
            <p><strong>Analizando Log:</strong> <em id="ai-log-mensaje"></em></p>
            <hr>
            <div id="ai-respuesta">
                <p>Consultando al modelo local (phi3:mini)...</p>
            </div>
        </div>
    </div>


{% endblock %}



{% block scripts %}
<script>
    // --- VARIABLES GLOBALES PARA ESTADO ---
    let currentPage = 1;
    const logsPorPagina = 10;

    // --- Variables globales para los gr√°ficos (¬°IMPORTANTE!) ---
    // Las guardamos aqu√≠ para poder "destruirlas" antes de volver a dibujarlas
    let chartNivelInstance;
    let chartIPsInstance;

    // Este script se ejecuta cuando el navegador termina de cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        cargarLogs(currentPage); 
        cargarStats();

        setInterval(() =>{
            console.log("Actualizando dashboard en vivo...");
            cargarLogs(currentPage);
            cargarStats();
        }, 5000);
    });

    // --- FUNCI√ìN 'cambiarPagina' (Sin cambios) ---
    function cambiarPagina(direccion) {
        if (direccion === 'siguiente') {
            currentPage++;
        } else if (direccion === 'anterior') {
            currentPage--;
        }
        cargarLogs(currentPage);
    }

    // --- FUNCI√ìN 'cargarLogs' (Sin cambios) ---
    function cargarLogs(page) {
        const tableBody = document.getElementById('log-table-body');
        fetch(`/api/logs?page=${page}&per_page=${logsPorPagina}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = ''; 
                data.logs.forEach(log => {
                    const row = document.createElement('tr');
                    if (log.severidad.includes('ALERTA')) {
                        row.style.color = '#ff6b6b'; 
                    } else if (log.severidad === 'AVISO') {
                        row.style.color = '#ffb86c';
                    }
                    row.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.ip}</td>
                        <td>${log.severidad}</td>
                        <td>${log.mensaje}</td>
                        <td>
                            ${log.severidad.includes('ALERTA') || log.severidad.includes('AVISO') ? 
                                `<button class="btn-ia" onclick="analizarLogIA('${log.mensaje}')">ü§ñ IA</button>` :
                                ''}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                const pageInfo = document.getElementById('page-info');
                pageInfo.textContent = `P√°gina ${data.current_page} de ${data.total_pages}`;
                currentPage = data.current_page;
                document.getElementById('btn-anterior').disabled = (data.current_page === 1);
                document.getElementById('btn-siguiente').disabled = (data.current_page === data.total_pages);
            })
            .catch(error => {
                console.error('Error al cargar los logs:', error);
                tableBody.innerHTML = '<tr><td colspan="4">Error al cargar datos de la API.</td></tr>';
            });
    }

    // --- ¬°¬°FUNCI√ìN 'cargarStats' TOTALMENTE REESCRITA!! ---
    function cargarStats() {
        const statsContent = document.getElementById('stats-content');

        fetch('/api/stats')
            .then(response => response.json())
            .then(stats => {
                if (stats.error) {
                    console.error('Error recibido desde la API /api/stats:', stats.error);
                    statsContent.innerHTML = `<p style="color: #ff6b6b;">Error de servidor al generar estad√≠sticas.</p>`;
                    return; 
                }

                // ¬°Aqu√≠ dibujamos los gr√°ficos!

                // --- 1. Gr√°fico de Tarta (Niveles) ---
                const ctxNivel = document.getElementById('chartNivel').getContext('2d');

                // Destruimos el gr√°fico anterior si existe (para evitar bugs al refrescar)
                if (chartNivelInstance) {
                    chartNivelInstance.destroy();
                }

                chartNivelInstance = new Chart(ctxNivel, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(stats.conteo_por_nivel),
                        datasets: [{
                            label: 'Conteo por Nivel',
                            data: Object.values(stats.conteo_por_nivel),
                            backgroundColor: [
                                'rgba(255, 107, 107, 0.7)', // Rojo (ERROR)
                                'rgba(110, 219, 110, 0.7)', // Verde (INFO)
                                'rgba(255, 184, 108, 0.7)'  // Naranja (WARN)
                            ],
                            borderColor: '#1e1e1e',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: '#e0e0e0' } } }
                    }
                });

                // --- 2. Gr√°fico de Barras (Top IPs) ---
                const ctxIPs = document.getElementById('chartIPs').getContext('2d');

                if (chartIPsInstance) {
                    chartIPsInstance.destroy();
                }

                chartIPsInstance = new Chart(ctxIPs, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(stats.top_5_ips),
                        datasets: [{
                            label: 'Eventos por IP',
                            data: Object.values(stats.top_5_ips),
                            backgroundColor: 'rgba(76, 175, 80, 0.7)', // Verde SIEM
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { color: '#e0e0e0', stepSize: 1 },
                                grid: { color: '#444' }
                            },
                            x: {
                                ticks: { color: '#e0e0e0' },
                                grid: { color: '#444' }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error de red al cargar las estad√≠sticas:', error);
                statsContent.innerHTML = '<p style="color: #ff6b6b;">Error de red al cargar estad√≠sticas.</p>';
            });
    }

    // ... (Tu funci√≥n cargarStats() termina aqu√≠) ...

        // --- ¬°NUEVAS FUNCIONES DE IA (M√ìDULO 5)! ---

        function abrirModal() {
            document.getElementById('ai-modal').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        function analizarLogIA(mensajeLog) {
            // 1. Abrimos el modal y mostramos un estado de "cargando"
            abrirModal();
            document.getElementById('ai-log-mensaje').textContent = mensajeLog;
            document.getElementById('ai-respuesta').innerHTML = "<p>Consultando al modelo (phi3:mini)...</p>";

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // 2. Llamamos a nuestra nueva API de IA (¬°con POST!)
            fetch('/api/explain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                // 3. Enviamos el mensaje del log en el body
                body: JSON.stringify({ 
                    mensaje: mensajeLog 
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Si el servidor da un error (ej. 500), lo manejamos
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                // 4. ¬°√âxito! Mostramos la explicaci√≥n de la IA
                // (Usamos <pre> para preservar los saltos de l√≠nea que d√© la IA)
                document.getElementById('ai-respuesta').innerHTML = `<pre>${data.explicacion}</pre>`;
            })
            .catch(error => {
                // 5. Manejamos cualquier error (de red o del servidor)
                console.error('Error al analizar con IA:', error);
                document.getElementById('ai-respuesta').innerHTML = `<p style="color: #ff6b6b;">Error: ${error.error || 'No se pudo contactar a la IA.'}</p>`;
            });
        }
 
</script>
{% endblock %}