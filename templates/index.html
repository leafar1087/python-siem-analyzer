{% extends "base.html" %}

{% block content %}

    <div id="stats-container">
        <h2>Estadísticas Clave</h2>
        <div id="stats-content">
            <p>Cargando estadísticas...</p>
        </div>
    </div>

    <div id="log-container">
        <h2>Logs en Vivo</h2>
        <table width="100%">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>IP de Origen</th>
                    <th>Severidad</th>
                    <th>Mensaje</th>
                </tr>
            </thead>
            <tbody id="log-table-body">
                <tr><td colspan="4">Cargando datos desde la API...</td></tr>
            </tbody>
        </table>

        <div id="pagination-controls" style="margin-top: 15px; text-align: center;">
            <button id="btn-anterior" onclick="cambiarPagina('anterior')">&laquo; Anterior</button>
            <span id="page-info" style="margin: 0 15px;">Página ? de ?</span>
            <button id="btn-siguiente" onclick="cambiarPagina('siguiente')">Siguiente &raquo;</button>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    // --- VARIABLES GLOBALES PARA ESTADO ---
    let currentPage = 1;
    const logsPorPagina = 10; 

    // Este script se ejecuta cuando el navegador termina de cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        cargarLogs(currentPage); 
        cargarStats();
    });

    // ... (Tu función 'cambiarPagina' completa aquí) ...
    function cambiarPagina(direccion) {
        if (direccion === 'siguiente') {
            currentPage++;
        } else if (direccion === 'anterior') {
            currentPage--;
        }
        cargarLogs(currentPage);
    }

    // ... (Tu función 'cargarLogs' completa aquí) ...
    function cargarLogs(page) {
        const tableBody = document.getElementById('log-table-body');
        fetch(`/api/logs?page=${page}&per_page=${logsPorPagina}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = ''; 
                data.logs.forEach(log => {
                    const row = document.createElement('tr');
                    if (log.severidad.includes('ALERTA')) {
                        row.style.color = '#ff6b6b'; 
                    } else if (log.severidad === 'AVISO') {
                        row.style.color = '#ffb86c';
                    }
                    row.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.ip}</td>
                        <td>${log.severidad}</td>
                        <td>${log.mensaje}</td>
                    `;
                    tableBody.appendChild(row);
                });

                const pageInfo = document.getElementById('page-info');
                pageInfo.textContent = `Página ${data.current_page} de ${data.total_pages}`;
                currentPage = data.current_page;
                document.getElementById('btn-anterior').disabled = (data.current_page === 1);
                document.getElementById('btn-siguiente').disabled = (data.current_page === data.total_pages);
            })
            .catch(error => {
                console.error('Error al cargar los logs:', error);
                tableBody.innerHTML = '<tr><td colspan="4">Error al cargar datos de la API.</td></tr>';
            });
    }

    // ... (Tu función 'cargarStats' completa aquí) ...
    function cargarStats() {
        const statsContent = document.getElementById('stats-content');
        fetch('/api/stats')
            .then(response => response.json())
            .then(stats => {
                if (stats.error) {
                    console.error('Error recibido desde la API /api/stats:', stats.error);
                    statsContent.innerHTML = `<p style="color: #ff6b6b;">Error de servidor al generar estadísticas: ${stats.error}. Revisa el terminal de Flask.</p>`;
                    return; 
                }
                const statsHtml = `
                    <p><strong>Total de Logs Analizados:</strong> ${stats.total_logs}</p>
                    <strong>Conteo por Nivel:</strong>
                    <ul>
                        ${Object.entries(stats.conteo_por_nivel).map(([nivel, conteo]) => 
                            `<li>${nivel}: ${conteo}</li>`
                        ).join('')}
                    </ul>
                    <strong>Top 5 IPs Activas:</strong>
                    <ul>
                        ${Object.entries(stats.top_5_ips).map(([ip, conteo]) => 
                            `<li>${ip}: ${conteo} eventos</li>`
                        ).join('')}
                    </ul>
                `;
                statsContent.innerHTML = statsHtml;
            })
            .catch(error => {
                console.error('Error de red al cargar las estadísticas:', error);
                statsContent.innerHTML = '<p style="color: #ff6b6b;">Error de red al cargar estadísticas.</p>';
            });
    }
</script>
{% endblock %}