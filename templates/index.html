{% extends "base.html" %}

{% block title %}Dashboard - SIEM{% endblock %}

{% block content %}

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" onclick="cargarLogs(currentPage); cargarStats();">
            <i class="fas fa-sync-alt fa-sm text-white-50"></i> Actualizar Ahora
        </a>
    </div>

    <!-- Correlation Alerts Widget -->
    <div id="correlation-alerts-widget" class="mb-4" style="display: none;">
        <div class="card border-left-danger shadow">
            <div class="card-header py-3 bg-gradient-danger">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="m-0 font-weight-bold text-white">
                            <i class="fas fa-exclamation-triangle"></i> ALERTAS DE CORRELACIÓN
                        </h6>
                    </div>
                    <div class="col-auto">
                        <span class="badge badge-light" id="corr-total-badge">0</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3 text-center">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Críticas</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="corr-critical">0</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Altas</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="corr-high">0</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Medias</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="corr-medium">0</div>
                    </div>
                    <div class="col-md-3 text-center">
                        <a href="{{ url_for('correlations') }}" class="btn btn-primary btn-sm btn-block">
                            Ver Todas <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <div id="top-correlations-list">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <!-- Columna Izquierda: Estadísticas -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Estadísticas Clave</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="chartNivel"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-danger"></i> ERROR
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-success"></i> INFO
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-warning"></i> WARN
                        </span>
                    </div>
                    
                    <hr>
                    
                    <div class="chart-bar">
                        <canvas id="chartIPs"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Logs -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Logs en Vivo <small id="last-updated" class="text-muted ml-2"></small></h6>
                    
                    <div class="d-flex align-items-center">
                        <select id="per-page-select" class="form-control form-control-sm mr-2" style="width: auto;" onchange="cambiarTamanoPagina()">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar..." onkeyup="debounceSearch()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>IP</th>
                                    <th>Severidad</th>
                                    <th>Mensaje</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body">
                                <tr><td colspan="5" class="text-center">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="btn-group">
                            <button id="btn-primero" class="btn btn-sm btn-secondary" onclick="cambiarPagina('primero')"><i class="fas fa-angle-double-left"></i></button>
                            <button id="btn-anterior" class="btn btn-sm btn-secondary" onclick="cambiarPagina('anterior')"><i class="fas fa-angle-left"></i></button>
                        </div>
                        <span id="page-info" class="small">Página ? de ?</span>
                        <div class="btn-group">
                            <button id="btn-siguiente" class="btn btn-sm btn-secondary" onclick="cambiarPagina('siguiente')"><i class="fas fa-angle-right"></i></button>
                            <button id="btn-ultimo" class="btn btn-sm btn-secondary" onclick="cambiarPagina('ultimo')"><i class="fas fa-angle-double-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de IA (Bootstrap 4 compatible) -->
    <div class="modal fade" id="aiModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-gradient-success text-white">
                    <h5 class="modal-title"><i class="fas fa-robot mr-2"></i>Asistente de Análisis IA</h5>
                    <button class="close text-white" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-1">Analizando Log:</p>
                    <div class="alert alert-secondary font-monospace small mb-3 text-dark" id="ai-log-mensaje"></div>
                    <hr>
                    <div id="ai-respuesta">
                        <div class="d-flex align-items-center text-info">
                            <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
                            Consultando al modelo local (phi3:mini)...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    // Variables Globales
    let currentPage = 1;
    let totalPages = 1;
    let logsPorPagina = 10;
    let searchTimeout = null;
    
    // Variables para los gráficos (Chart.js)
    let chartNivelInstance = null;
    let chartIPsInstance = null;

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        cargarStats();
        cargarLogs(currentPage);
        cargarCorrelaciones();

        // Auto-refresh cada 5 segundos
        setInterval(() => {
            // Solo actualizamos si no estamos buscando o editando
            const searchTerm = document.getElementById('search-input').value;
            if (!searchTerm) {
                cargarStats();
                cargarLogs(currentPage);
                cargarCorrelaciones();
            }
        }, 5000);
    });

    // --- FUNCIONES DE CARGA DE DATOS ---

    function cargarStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(stats => {
                if (stats.error) return;

                try {
                    // 1. Gráfico de Tarta (Nivel)
                    const ctxNivel = document.getElementById('chartNivel');
                    if (ctxNivel) {
                        if (chartNivelInstance) chartNivelInstance.destroy();
                        chartNivelInstance = new Chart(ctxNivel.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(stats.conteo_por_nivel),
                                datasets: [{
                                    data: Object.values(stats.conteo_por_nivel),
                                    backgroundColor: ['#e74a3b', '#1cc88a', '#f6c23e'],
                                    hoverBackgroundColor: ['#e02d1b', '#17a673', '#dda20a'],
                                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                tooltips: {
                                    backgroundColor: "rgb(255,255,255)",
                                    bodyFontColor: "#858796",
                                    borderColor: '#dddfeb',
                                    borderWidth: 1,
                                    xPadding: 15,
                                    yPadding: 15,
                                    displayColors: false,
                                    caretPadding: 10,
                                },
                                legend: { display: false },
                                cutoutPercentage: 80,
                            }
                        });
                    }

                    // 2. Gráfico de Barras (IPs)
                    const ctxIPs = document.getElementById('chartIPs');
                    if (ctxIPs) {
                        if (chartIPsInstance) chartIPsInstance.destroy();
                        chartIPsInstance = new Chart(ctxIPs.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: Object.keys(stats.top_5_ips),
                                datasets: [{
                                    label: 'Eventos',
                                    data: Object.values(stats.top_5_ips),
                                    backgroundColor: "#4e73df",
                                    hoverBackgroundColor: "#2e59d9",
                                    borderColor: "#4e73df",
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                layout: { padding: { left: 10, right: 25, top: 25, bottom: 0 } },
                                scales: {
                                    xAxes: [{
                                        gridLines: { display: false, drawBorder: false },
                                        ticks: { maxTicksLimit: 6 },
                                        maxBarThickness: 25,
                                    }],
                                    yAxes: [{
                                        ticks: { min: 0, maxTicksLimit: 5, padding: 10 },
                                        gridLines: { color: "rgb(234, 236, 244)", zeroLineColor: "rgb(234, 236, 244)", drawBorder: false, borderDash: [2], zeroLineBorderDash: [2] }
                                    }],
                                },
                                legend: { display: false },
                                tooltips: {
                                    backgroundColor: "rgb(255,255,255)",
                                    bodyFontColor: "#858796",
                                    titleMarginBottom: 10,
                                    titleFontColor: '#6e707e',
                                    titleFontSize: 14,
                                    borderColor: '#dddfeb',
                                    borderWidth: 1,
                                    xPadding: 15,
                                    yPadding: 15,
                                    displayColors: false,
                                    intersect: false,
                                    mode: 'index',
                                    caretPadding: 10,
                                }
                            }
                        });
                    }
                } catch (err) {
                    console.error("Error al inicializar gráficos:", err);
                }
            })
            .catch(e => console.error("Error en cargarStats:", e));
    }

    function cargarLogs(page) {
        const tableBody = document.getElementById('log-table-body');
        const searchTerm = document.getElementById('search-input').value;
        const updateIndicator = document.getElementById('last-updated');

        if (updateIndicator) updateIndicator.textContent = 'Actualizando...';

        fetch(`/api/logs?page=${page}&per_page=${logsPorPagina}&search=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = ''; 
                if(data.logs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No hay logs disponibles.</td></tr>';
                    document.getElementById('page-info').textContent = `Página 0 de 0`;
                    return;
                }

                data.logs.forEach(log => {
                    // Defensive checks
                    const safeMensaje = log.mensaje || "";
                    const safeSeveridad = log.severidad || "INFO";
                    const safeNivel = log.nivel || "INFO";
                    const safeIP = log.ip || "Unknown";
                    const safeTimestamp = log.timestamp || "";

                    const row = document.createElement('tr');
                    
                    let badgeClass = 'badge-secondary';
                    if (safeSeveridad.includes('ALERTA') || safeNivel === 'ERROR') badgeClass = 'badge-danger';
                    else if (safeSeveridad === 'AVISO' || safeNivel === 'WARN') badgeClass = 'badge-warning text-dark';
                    else badgeClass = 'badge-success';

                    row.innerHTML = `
                        <td class="text-nowrap small">${safeTimestamp}</td>
                        <td class="text-monospace small">${safeIP}</td>
                        <td><span class="badge ${badgeClass}">${safeSeveridad}</span></td>
                        <td class="text-break small">${safeMensaje.substring(0, 80)}${safeMensaje.length > 80 ? '...' : ''}</td>
                        <td class="text-center">
                            ${(safeSeveridad.includes('ALERTA') || safeSeveridad.includes('AVISO') || safeNivel === 'ERROR') ? 
                                `<button class="btn btn-sm btn-info btn-circle" onclick="analizarLogIA('${safeMensaje.replace(/'/g, "\\'")}')" title="Analizar con IA">
                                    <i class="fas fa-robot"></i>
                                </button>` : ''}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                currentPage = data.current_page;
                totalPages = data.total_pages;
                
                document.getElementById('page-info').textContent = `Página ${data.current_page} de ${data.total_pages}`;
                
                if (updateIndicator) {
                    const now = new Date();
                    updateIndicator.textContent = 'Actualizado: ' + now.toLocaleTimeString();
                }
                
                document.getElementById('btn-primero').disabled = (data.current_page === 1);
                document.getElementById('btn-anterior').disabled = (data.current_page === 1);
                document.getElementById('btn-siguiente').disabled = (data.current_page === data.total_pages);
                document.getElementById('btn-ultimo').disabled = (data.current_page === data.total_pages);
            })
            .catch(error => {
                console.error('Error:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar datos: ' + error.message + '</td></tr>';
            });
    }

    // --- FUNCIONES DE INTERACCIÓN ---

    function cambiarPagina(accion) {
        if (accion === 'primero') currentPage = 1;
        else if (accion === 'anterior' && currentPage > 1) currentPage--;
        else if (accion === 'siguiente' && currentPage < totalPages) currentPage++;
        else if (accion === 'ultimo') currentPage = totalPages;
        
        cargarLogs(currentPage);
    }

    function cambiarTamanoPagina() {
        logsPorPagina = document.getElementById('per-page-select').value;
        currentPage = 1; // Reset to first page
        cargarLogs(currentPage);
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            cargarLogs(currentPage);
        }, 300);
    }

    function analizarLogIA(mensajeLog) {
        document.getElementById('ai-log-mensaje').textContent = mensajeLog;
        document.getElementById('ai-respuesta').innerHTML = `
            <div class="d-flex align-items-center text-info">
                <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
                Consultando al modelo local (phi3:mini)...
            </div>
        `;
       
       $('#aiModal').modal('show');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/api/explain', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ mensaje: mensajeLog })
        })
        .then(r => r.json())
        .then(data => {
            if(data.error) throw new Error(data.error);
            document.getElementById('ai-respuesta').innerHTML = `
                <div class="p-3 bg-gray-200 rounded border border-secondary">
                    <pre class="mb-0 text-dark" style="white-space: pre-wrap; font-family: 'Consolas', monospace;">${data.explicacion}</pre>
                </div>
            `;
        })
        .catch(err => {
            document.getElementById('ai-respuesta').innerHTML = `<div class="alert alert-danger mb-0">${err.message || 'Error desconocido'}</div>`;
        });
    }

    // ==================== CORRELACIÓN DE EVENTOS ====================
    
    function cargarCorrelaciones() {
        fetch('/api/correlations/summary')
            .then(response => response.json())
            .then(data => {
                const widget = document.getElementById('correlation-alerts-widget');
                
                if (data.total_active > 0) {
                    widget.style.display = 'block';
                    document.getElementById('corr-total-badge').textContent = data.total_active;
                    document.getElementById('corr-critical').textContent = data.severity_counts.CRITICAL || 0;
                    document.getElementById('corr-high').textContent = data.severity_counts.HIGH || 0;
                    document.getElementById('corr-medium').textContent = data.severity_counts.MEDIUM || 0;
                    
                    const cardHeader = widget.querySelector('.card-header');
                    if (data.has_critical) {
                        cardHeader.classList.remove('bg-gradient-warning');
                        cardHeader.classList.add('bg-gradient-danger');
                    }
                    
                    renderTopCorrelations(data.top_correlations);
                } else {
                    widget.style.display = 'none';
                }
            })
            .catch(error => console.error('Error cargando correlaciones:', error));
    }
    
    function renderTopCorrelations(correlations) {
        const container = document.getElementById('top-correlations-list');
        if (correlations.length === 0) { container.innerHTML = ''; return; }
        
        let html = '<div class="list-group">';
        correlations.forEach(corr => {
            const severityBadge = {'CRITICAL':'<span class="badge badge-danger ml-2">CRÍTICA</span>','HIGH':'<span class="badge badge-warning ml-2">ALTA</span>','MEDIUM':'<span class="badge badge-info ml-2">MEDIA</span>'}[corr.severity] || '';
            const typeIcon = {'brute_force':'fas fa-user-lock','port_scan':'fas fa-network-wired','suspicious_ip':'fas fa-exclamation-triangle','time_anomaly':'fas fa-clock'}[corr.correlation_type] || 'fas fa-question-circle';
            const typeName = {'brute_force':'Fuerza Bruta','port_scan':'Escaneo de Puertos','suspicious_ip':'IP Sospechosa','time_anomaly':'Anomalía Temporal'}[corr.correlation_type] || corr.correlation_type;
            
            html += `<a href="{{ url_for('correlations') }}" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <h6 class="mb-1"><i class="${typeIcon}"></i> ${typeName} ${severityBadge}</h6>
                    <small class="text-muted">${corr.event_count} eventos</small>
                </div>
                <p class="mb-1 small">${corr.description}</p>
                <small class="text-muted">IP: <code>${corr.source_ip}</code></small>
            </a>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }
</script>
{% endblock %}